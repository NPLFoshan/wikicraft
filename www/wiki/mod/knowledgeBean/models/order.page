<?npl
--[[
Title: knowledge bean api
Author(s): big
Date: 2018.9.25
Place: Foshan
Desc: knowledge bean api
Api Example:
/api/mod/knowledgeBean/models/knowledgeBean/... (models api)
]]

include_once(WIKI_ROOT .. "models/abstract/multi_user_base.page")
include_once(WIKI_ROOT .. "models/goods.page")
include_once(WIKI_ROOT .. "models/oauth_app.page")
include_once("./orderNumber.page")
include_once("./beans.page")

local order = inherit(models.abstract.multi_user_base, gettable("models.knowledgeBean.order"))

order.db_name = 'knowledge_bean_order'
order.showList = {"魔法豆"}

local goods = models.goods:new()
local oauth_app = models.oauth_app:new()
local orderNumber = models.knowledgeBean.orderNumber:new()

function order:ctor()
  self:addfield('buyGoodsList', 'table', true)
end

function order:api_getGoodsList()
  local goodsList = commonlib.Array:new()

  for key, item in ipairs(self.showList) do
    local currentGoods = goods:getGoodsBySubject(item)

    if currentGoods then
      goodsList:push_back(currentGoods)
    end
  end

  return errors:wrap(nil, goodsList)
end

-- buy haqi goods
-- We will try to buy haqi goods. If haqi server return success msg, we will deduct user beans otherwise will not.
function order:api_spend(params)
  self:ensureAuthenticated()

  local err, query = self:validateQuery(params)

  if not query.buyGoodsList then
    return errors:wrap(errors.REQUEST_PARAMS_ERROR)
  end

  local buyGoodsList = query.buyGoodsList
  local newOrder = self:addOrder(buyGoodsList)

  if not newOrder then
    return errors:wrap(errors.SERVER_INNER_ERROR)
  end

  if self:handleBuy(buyGoodsList) then

  end

  return errors:wrap(newOrder)
end

function order:handleBuy(buyGoodsList)
  log('from handle buy', true)
  self.index = self.index and self.index + 1 or 1

  if type(buyGoodsList) ~= 'table' then
    self.index = nil
    return false
  end

  local curGoods = buyGoodsList[self.index]

  if not curGoods or type(curGoods['goodsId']) ~= 'number' then
    self.index = nil
    return false
  end

  local curGoodsInfo = goods:getGoodsById(curGoods['goodsId'])

  if not curGoodsInfo and curGoodsInfo.app_name then
    return false
  end

  if not self:buyGoods(curGoods, curGoodsInfo) then
    return false
  end

  if buyGoodsList[#buyGoodsList + 1] then
    if not self:handleBuy(buyGoodsList) then
      return false
    end
  else
    return true
  end
end

function order:buyGoods(curGoods, curGoodsInfo)
  local oauthAppInfo = oauth_app:getByAppName(curGoodsInfo.app_name)

  if oauthAppInfo then
    return false
  end

  local url = oauthAppInfo.payCallbackUrl;

  log('----------------')
  log(url, true)
  log(curGoodsInfo, true)

  -- apiParams.url = 'Pay'
  -- apiParams.gsid = tostring(query.app_goods_id)
  -- apiParams.count = tostring(toFen/100 * 10)
  -- apiParams.money = tostring(toFen)
  -- apiParams.method = "1"
  -- apiParams.orderno = tostring(trade_no)
  -- apiParams.from = "0"
  -- apiParams.price = payInfo.price
  -- apiParams.username = payInfo.username

  -- url = url .. "?";

  -- for key,value in pairs(apiParams or {}) do
  --   url = url .. key .. "=" .. value .. "&";
  -- end

  -- url = string.sub(url, 1, -2);

	-- local err, data = self:http("GET", url, {});

	-- if(not chargeObject) then
	-- 	return errors:wrap(errors.SERVER_INNER_ERROR);
	-- end
end

function order:addOrder(buyGoodsList)
  local orderNo = orderNumber:getOrder()
  local username = self:getUsername()

  if not username then
    return false
  end

  for key, item in ipairs(buyGoodsList) do
    item.goodsNo = format("%s%s", orderNo, key)
  end

  local order = {
    username = username,
    orderNo = orderNo,
    status = false,
    buyGoodsList = buyGoodsList
  }

  self:db():insertOne(order, resume)
  local err, result = yield()

  if not err and result then
    return order
  else
    return false
  end
end

function order:modifyOrder()

end

function order:getOrder()

end


